ALTER TABLE BOOKS ADD BESTSELLER BOOLEAN DEFAULT 0;

DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
   DECLARE RENTAMOUNT, DAYS, CURRENT_BOOK_ID INT;
   DECLARE RENTSPERMONTH DECIMAL(5,2);
   DECLARE FINISHED INT DEFAULT 0;
   DECLARE ALL_RENTS CURSOR FOR SELECT BOOK_ID FROM RENTS;
   DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
   OPEN ALL_RENTS;
   WHILE (FINISHED = 0) DO
      FETCH ALL_RENTS INTO CURRENT_BOOK_ID;
      IF (FINISHED = 0) THEN
         SELECT COUNT(*) FROM RENTS
            WHERE BOOK_ID = CURRENT_BOOK_ID
               INTO RENTAMOUNT;

SELECT DATEDIFF(MAX(RENT_DATE), MIN(RENT_DATE)) + 1 FROM RENTS
            WHERE BOOK_ID = CURRENT_BOOK_ID
               INTO DAYS;

SET RENTSPERMONTH = RENTAMOUNT / DAYS * 30;

		IF (RENTAMOUNT >2 && RENTSPERMONTH >= 3) THEN
         UPDATE BOOKS SET BESTSELLER = TRUE
            WHERE BOOK_ID = CURRENT_BOOK_ID;
         COMMIT;
	END IF;
      END IF;
   END WHILE;

   CLOSE ALL_RENTS;
END $$

DELIMITER ;
